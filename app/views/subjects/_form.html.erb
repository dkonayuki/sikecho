<div id="subject-edit">
	<%= form_for(shallow_args(@subject.course, @subject)) do |f| %>
	  <% if @subject.errors.any? %>
	    <div id="error_explanation">
	      <h2><%= pluralize(@subject.errors.count, "error") %> prohibited this subject from being saved:</h2>
	
	      <ul>
	      <% @subject.errors.full_messages.each do |msg| %>
	        <li><%= msg %></li>
	      <% end %>
	      </ul>
	    </div>
	  <% end %>
	  
	<div class="skc-box skc-box-lg">
			<div class="skc-box-content">
				<div class="skc-box-thumbnail">
					<%= image_tag("lecture.png")  %>
				</div>
				<div class="skc-box-title">
	    		<%= f.text_area :name, class: 'form-control', rows: 1, placeholder: '授業名' %>
					<hr />
		    </div>
				<div class="skc-box-desc">
					<p>
						<strong>概要:</strong>
						<%= f.text_area :description, class: 'form-control', id: 'subject-description' %>
					</p>
					<p>
						<strong>所属学科:</strong>
						<% if @subject.course %>
						<%= f.select :course_id	, options_from_collection_for_select(@courses,"id","name", selected: @subject.course.id), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% else %>
						<%= f.select :course_id	, options_from_collection_for_select(@courses,"id","name"), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% end %>
					</p>
					<p>
						<strong>学年:</strong>
						<% if @subject.uni_year %>
						<%= f.select :uni_year_id	, options_from_collection_for_select(@uni_years,"id","name", selected:@subject.uni_year.id), {include_blank: true}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% else %>
						<%= f.select :uni_year_id	, options_from_collection_for_select(@uni_years,"id","name"), {include_blank: true}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% end %>
						<br/>
						<strong>学期:</strong>
						<% if @subject.semester %>
						<%= f.select :semester_id, options_from_collection_for_select(@semesters,"id","name",selected: @subject.semester.id), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% else %>
						<%= f.select :semester_id, options_from_collection_for_select(@semesters,"id","name"), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% end %>
					</p>
					<p>
						<strong>年度:</strong>
						<% if @subject.year %>
						<%= f.select :year, options_for_select(@years, selected: @subject.year), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% else %>
						<%= f.select :year, options_for_select(@years), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% end %>
					</p>
					<p>
						<strong>講義室:</strong>
						<%= f.text_field :place, class: 'form-control form-control-inline' %>
					</p>
					<p>
						<strong>教員:</strong>
						<% if @subject.teachers %>
						<%= select_tag :teachers, options_for_select(@teachers.map { |t| [t.name_kanji, t.id] }, selected: @subject.teachers.map { |t| t.id }), class: 'selectpicker show-tick', data: {width: 'auto'}, multiple: true, title: '' %>
						<% else %>
						<%= select_tag :teachers, options_for_select(@teachers.map { |t| [t.name_kanji, t.id] }), class: 'selectpicker show-tick', data: {width: 'auto'}, multiple: true, title: '' %>
						<% end %>
					</p>
					<hr />
					<p>
						<h5>時間割</h5><br />
						<%= f.fields_for :periods do | builder | %>
							<%= render 'period_fields', f: builder %>		
						<% end %>
						<%= link_to_add_fields f, :periods, {class: 'btn btn-default'} do %>
						<span class="glyphicon glyphicon-plus"></span>追加
						<% end %>
					</p>
					<hr />
					<p>
						<strong>シラバス:</strong>
						<% if @subject.number_of_outlines %>
						<%= f.select :number_of_outlines, options_for_select(@number_of_outlines_list, selected: @subject.number_of_outlines), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<%= hidden_field_tag "old_number", @subject.number_of_outlines %>
						<% else %>
						<%= f.select :number_of_outlines, options_for_select(@number_of_outlines_list), {}, {class: 'selectpicker show-tick', data: {width: 'auto'}} %>
						<% end %>
					</p>
					<div class='tag-form'>
						<div class='tag-menu'>
				   		<div class="btn btn-primary btn-xs tag-menu-btn">ゼミ</div>
				   		<div class="btn btn-primary btn-xs tag-menu-btn">通年</div>
				   		<div class="btn btn-primary btn-xs tag-menu-btn">集中講義</div>
				   		<div id="remove-all" class="btn btn-danger btn-xs"><span class="glyphicon glyphicon-remove"></span>クリア</div>
			      </div>
			      <%= text_area_tag 'tags', nil, class: 'tag-input' %>
					</div>
				</div>
				<br />
				<%= f.submit '登録', class: 'btn btn-success col-sm-2 col-sm-offset-5 col-xs-12 col-xs-offset-0' %>
			</div>
		</div>
		
	<% end %>
</div>

<script>
$(document).ready(function() {

	$("#subject-description").wysihtml5({locale: "en-US"});
	function change_uni_year() {
		var uni_year_id = $("#subject_uni_year_id").val();
		$.ajax({
				url:"<%= url_for(action: 'semester', controller: 'subjects') %>",	
				data:'uni_year_id=' + uni_year_id,
			}
		);
	}
	
	$('.selectpicker').selectpicker();
	$('#subject_uni_year_id').on("change", change_uni_year);
	
	// instantiate the bloodhound suggestion engine
	var tags = new Bloodhound({
	  datumTokenizer: function(d) { return Bloodhound.tokenizers.whitespace(d.name); },
	  queryTokenizer: Bloodhound.tokenizers.whitespace,
	  limit: 5,
	  prefetch: {
	  	ttl: 0,
	    url: '/tags.json',
	    filter: function(list) {
	      return $.map(list, function(tag) { return { name: tag.name }; });
	    }
	  }
	});
	 
	// initialize the bloodhound suggestion engine
	tags.initialize();
	
	//initiate tagsinput	
	$('.tag-input').tagsinput({
		tagClass: function(item) {
	    switch (item) {
	    	case 'ゼミ': return 'label label-danger';
	      case '通年': return 'label label-warning';
	      case '集中講義': return 'label label-success';
	      default: return 'label label-info';
	    }
  	},
		confirmKeys: [13, 9]
	});

	$('.tag-input').tagsinput('input').typeahead(null, {
		// instantiate the typeahead UI
		  displayKey: 'name',
 			source: tags.ttAdapter()
	}).bind('typeahead:selected', $.proxy(function (obj, datum) {  
	  this.tagsinput('add', datum.value);
	  //this.tagsinput('input').typeahead('val','');
	}, $('.tag-input')));
	
	//menu bar
	$('.tag-menu-btn').on('click', function() {
		$('.tag-input').tagsinput('add', this.innerHTML );
	});
	$('#remove-all').on('click', function() {
		$('.tag-input').tagsinput('removeAll');
	});
	
	//fix for left over text
	$('.bootstrap-tagsinput input').blur(function() {
		$(this).val('');
	});
	
	//add old tags if exist
	<% if @tags != nil %>
		<% @tags.each do |tag| %>
				$('.tag-input').tagsinput('add', "<%= tag %>" );
		<% end %>
	<% end %>
	
});
</script>
