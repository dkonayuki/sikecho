<nav class="navbar navbar-default" role="navigation" id="nav-bar">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
	  <button type="button" class="navbar-toggle pull-right <%= 'hidden-xs' if current_university == nil %>" data-toggle="collapse" data-target="#navbar-collapse-2" id="navbar-search">
	  	<span class="sr-only">Toggle navigation</span>
 			<i class="glyphicon glyphicon-search"></i>
 		</button>
    <button type="button" class="navbar-toggle pull-left" data-toggle="collapse" data-target="#navbar-collapse-1" id="navbar-menu">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <% if user_signed_in? %>
    	<%= link_to image_tag("logo.png"), root_path, class: 'navbar-brand', id: 'logo' %>
    <% else %>
    	<%= link_to image_tag("logo.png"), root_url(subdomain: ''), class: 'navbar-brand', id: 'logo' %>
    <% end %>
  </div>
  
  <!-- Menu bar -->
  <div class="collapse navbar-collapse no-transition" id="navbar-collapse-1">
    <ul class="nav navbar-nav hidden-xs">
      <li class="<%= 'active' if params[:controller] == 'subjects' %> <%= 'disabled' if current_university == nil %>"><%= link_to t('.subject'), subjects_path %></li>
      <li class="<%= 'active' if params[:controller] == 'notes' %> <%= 'disabled' if current_university == nil %>">
      	<%= link_to notes_path do %>
	      	<%= t '.note' %>
	      	<% if user_signed_in? && unread_notes_count > 0 %>
	      		<span class="badge badge-important"><%= unread_notes_count %></span>
	      	<% end %>
      	<% end %>
    	</li>
      <li class="<%= 'active' if params[:controller] == 'users' %> <%= 'disabled' if !user_signed_in? %>"><%= link_to t('.profile'), current_user %></li>
    </ul>
    
    <ul class="nav navbar-nav visible-xs nav-mobile">
    	
    	<% if current_university == nil %>
	      <li class="<%= 'active' if params[:controller] == 'subjects' %> col-xs-3 disabled">
	      	<%= link_to image_tag("lecture_disabled.png"), subjects_path %>
	    	</li>
	    	<li class="<%= 'active' if params[:controller] == 'notes' %> col-xs-3 disabled">
	      	<%= link_to notes_path do %>
		      	<%= image_tag("note_disabled.png") %>
	      	<% end %>
	    	</li>
    	<% else %>
	      <li class="<%= 'active' if params[:controller] == 'subjects' %> col-xs-3">
	      	<%= link_to image_tag("lecture.png"), subjects_path %>
	    	</li>
	  	  <li class="<%= 'active' if params[:controller] == 'notes' %> col-xs-3">
	      	<%= link_to notes_path do %>
		      	<%= image_tag("note.png") %>
		      	<% if user_signed_in? && unread_notes_count > 0 %>
		      		<span class="badge badge-important"><%= unread_notes_count %></span>
		      	<% end %>
	      	<% end %>
	    	</li>
    	<% end %>
    	
      <% if user_signed_in? %>
	      <li class="<%= 'active' if params[:controller] == 'users' %> col-xs-3">
	      	<%= link_to image_tag("user.png"), current_user %>
      	</li>
	      <li class="col-xs-3">
	      	<%= link_to image_tag("logout.png"), destroy_user_session_path, method: :delete %>
      	</li>
      <% else %>
	      <li class="<%= 'active' if params[:controller] == 'users' %> col-xs-3 disabled">
	      	<%= link_to image_tag("user_disabled.png"), current_user %>
      	</li>
	      <li class="col-xs-3">
	      	<%= link_to image_tag("login.png"), new_user_session_path %>
      	</li>
      <% end %>
    </ul>
  </div><!-- /.navbar-collapse -->
  
  <!-- Search bar -->
  <% if user_signed_in? || current_university != nil %>
	  <div class="collapse navbar-collapse no-transition" id="navbar-collapse-2">
		<%= form_tag search_path, class: "navbar-form navbar-left search-bar" do %>
		  <div class="input-group">
		    <%= text_field_tag :search, params[:search], class: 'form-control typeahead' %>
				<div class="input-group-btn">
					<%= button_tag(type: "submit", class: "btn btn-search") do %>
					  <i class="glyphicon glyphicon-search"></i>
					<% end %>
				</div>
			</div>	    
		<% end %>
	  </div><!-- /.navbar-collapse -->
  <% end %>
  
  <% if user_signed_in? %>
  <!-- User info -->
	<div class="collapse navbar-collapse hidden-xs" id="navbar-collapse-3">
		<ul class="nav navbar-nav navbar-right">
    	<li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><%= image_tag(current_user.display_profile_image, class: 'nav-avatar') %> <b class="caret"></b></a>
        <ul class="dropdown-menu" id="user-info-dropdown">
					<li>
						<%= link_to current_user do %>
							<%= image_tag('user_profile.png') %>
							<%= t('.profile') %>
						<% end %>
					</li>
					<li>
						<%= link_to schedule_path do %>
							<%= image_tag('user_schedule.png') %>
							<%= t('.schedule') %>
						<% end %>
					</li>
					<li class="divider"></li>
    			<li>
    				<%= link_to destroy_user_session_path, method: :delete do %>
    					<%= image_tag('user_logout.png') %>
    					<%= t('.logout') %>
    				<% end %>
    			</li>
        </ul>
      </li>
    </ul>
    <%= link_to image_tag("calendar.png", class: 'nav-calendar'), schedule_path, class: "nav navbar-nav navbar-right" %>
  </div><!-- /.navbar-collapse -->
  <% else %>
  <%= link_to t('.login'), new_user_session_path, class: 'btn btn-sm btn-orange navbar-right hidden-xs', id: 'login-btn' %>
	<% end %>
	
</nav>

<script>
	$(document).ready(function(){ 

	  /*For search bar submit*/
	  $(".search-bar").on("submit", function() {
	  	// default search is subject
	  	//window.location.href = "/" + I18n["meta"]["code"] + "/search?query=" + $(this).find("#query").val() + "&type=subject";
	  	window.location.href = "/" + I18n["meta"]["code"] + "/subjects?search=" + $(this).find("#search").val();
	  	return false;
	  });
	  
	  var subjectsList = new Bloodhound({
		  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
		  queryTokenizer: Bloodhound.tokenizers.whitespace,
		  //prefetch: '/subjects.json',
		  remote: '/search?q=%QUERY'
		});
		subjectsList.initialize();
		
		//$(".typeahead").typeahead("destroy");
		$('.typeahead').typeahead(null, {
		  displayKey: 'name',
		  source: subjectsList.ttAdapter(),
		  templates: {
				//empty: ,
		    suggestion: Handlebars.compile(
		      "<div class='subject-typeahead-item'>" +
			      "<a href={{typeahead_subject_path}}>" +
				      "<img src='{{typeahead_thumbnail}}'></img>" +
				      "<div class='subject-typeahead-content'>" +
				      	"<div class='subject-typeahead-name'>{{name}}</div>" +
				      	"<div class='subject-typeahead-info'>{{teachers.0.full_name}} &bull; {{year}}</div>" +
				      "</div>" +
			      "</a>" +
		      "</div>"
		    )
		  }
		});
		
		/*Fix keyboard focus on iphone*/
	  if (navigator.userAgent.match('CriOS')) {
			$("input").not(".search-bar #search").on('focus', function() {
		    $("#nav-bar").css("position", "absolute");
			});
			$("input").not(".search-bar #search").on('blur', function() {
		    $("#nav-bar").css("position", "fixed");
			})
		}

	});
</script>
